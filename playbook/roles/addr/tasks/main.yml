# -*- mode: yaml; mode: view -*-
---
- name: Fail on malformed IP
  fail:
    msg: "{{ item.1 }} is not IP address"
  when:
    - not item.1|ipaddr
  with_subelements:
    - "{{ addr_addr }}"
    - addr
  loop_control:
    label: "{{ item.0.dev }} IP {{ item.1 }} test"

- name: Delete IPs
  shell: >
    ip addr del {{ item.1 }} dev {{ item.0.dev }};
  with_subelements:
    - "{{ addr_addr }}"
    - addr
  when:
    - item.0.dev is defined
    - item.0.dev in ansible_interfaces
    # - item.1|ipaddr('address') not in ansible_facts[item.0.dev]['ipv4'] # may be dict OR list!
    - item.1|ipaddr('address') in ansible_all_ipv4_addresses
    - item.1.exclusive|d(true)
  loop_control:
    label: "ip addr del {{ item.1 }} dev {{ item.0.dev }}"
  failed_when: False

- name: Add IPs
  shell: >
    ip addr add {{ item.1 }} dev {{ item.0.dev }};
  with_subelements:
    - "{{ addr_addr }}"
    - addr
  loop_control:
    label: "ip addr add {{ item.1 }} dev {{ item.0.dev }}"
  when:
    - item.0.dev is defined
    - item.0.dev in ansible_interfaces
    - item.1|ipaddr('address') not in ansible_all_ipv4_addresses
...
